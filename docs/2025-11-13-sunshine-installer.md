# DGX Spark Sunshine Headless Setup Installer - Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create an automated installer for Sunshine headless streaming on NVIDIA DGX Spark (GB10) systems with interactive configuration, NVIDIA branding, and visual appeal.

**Architecture:** Single bash script with interactive prompts, automatic backups, and validation. Bundled EDID files and configuration templates. User selects resolution/codec/bitrate interactively, script downloads latest Sunshine from GitHub, configures virtual display via NVIDIA CustomEDID, and validates the installation.

**Tech Stack:** Bash, ANSI colors, curl, nvidia-xconfig, systemd, xrandr

---

## Task 1: Download Samsung Q800T EDID File

**Files:**
- Create: `edid/samsung-q800t.bin`

**Step 1: Download EDID from Linux TV repository**

```bash
cd /home/adminuser/repos/dgx-spark-sunshine-setup
curl -L "https://git.linuxtv.org/v4l-utils.git/plain/utils/edid-decode/data/samsung-q800t-hdmi2.1" \
  -o edid/samsung-q800t.bin
```

**Step 2: Verify EDID file**

Run: `file edid/samsung-q800t.bin`
Expected: "EDID data, version 1.3"

Run: `ls -lh edid/samsung-q800t.bin`
Expected: 256 bytes

**Step 3: Commit EDID file**

```bash
git add edid/samsung-q800t.bin
git commit -m "feat: add Samsung Q800T EDID for virtual display"
```

---

## Task 2: Create X11 Configuration Template

**Files:**
- Create: `templates/xorg.conf.template`

**Step 1: Create xorg.conf template**

```bash
cat > templates/xorg.conf.template << 'EOF'
# nvidia-xconfig: X configuration file for DGX Spark Sunshine Setup
# Generated by dgx-spark-sunshine-setup installer

Section "ServerLayout"
    Identifier     "Default Layout"
    Screen         "Screen0" 0 0
    InputDevice    "Keyboard0" "CoreKeyboard"
    InputDevice    "Mouse0" "CorePointer"
EndSection

Section "InputDevice"
    Identifier     "Keyboard0"
    Driver         "kbd"
EndSection

Section "InputDevice"
    Identifier     "Mouse0"
    Driver         "mouse"
    Option         "Protocol" "auto"
    Option         "Device" "/dev/psaux"
    Option         "Emulate3Buttons" "no"
    Option         "ZAxisMapping" "4 5"
EndSection

Section "Monitor"
    Identifier     "Monitor0"
    VendorName     "Virtual"
    ModelName      "Sunshine-Display"
    Option         "DPMS"
EndSection

Section "Device"
    Identifier     "NvidiaGB10"
    Driver         "nvidia"
    BusID          "{{BUS_ID}}"
    Option         "ConnectedMonitor" "DFP-0"
    Option         "CustomEDID" "DFP-0:/etc/X11/4k120.edid"
    Option         "IgnoreEDID" "false"
    Option         "UseEdidDpi" "false"
    Option         "AllowEmptyInitialConfiguration" "true"
EndSection

Section "Screen"
    Identifier     "Screen0"
    Device         "NvidiaGB10"
    Monitor        "Monitor0"
    DefaultDepth    24
    Option         "ConnectedMonitor" "DFP-0"
    Option         "CustomEDID" "DFP-0:/etc/X11/4k120.edid"
    SubSection     "Display"
        Virtual     3840 2160
        Depth       24
    EndSubSection
EndSection
EOF
```

**Step 2: Verify template created**

Run: `cat templates/xorg.conf.template | grep "{{BUS_ID}}"`
Expected: Line with BusID placeholder

**Step 3: Commit template**

```bash
git add templates/xorg.conf.template
git commit -m "feat: add xorg.conf template for virtual display"
```

---

## Task 3: Create Sunshine Configuration Template

**Files:**
- Create: `templates/sunshine.conf.template`

**Step 1: Create sunshine.conf template**

```bash
cat > templates/sunshine.conf.template << 'EOF'
# Sunshine Configuration - DGX Spark Headless Setup
# Generated by installer

# Display to capture
output_name = HDMI-0

# Video Quality Settings
# Bitrate in Kbps
bitrate = {{BITRATE}}

# Encoder: nvenc (hardware), software, quicksync, amdvce, vaapi
encoder = nvenc

# Codec: h264, hevc, av1
codec = {{CODEC}}

# FPS limit
fps = {{FPS}}

# Minimum quantization parameter (lower = higher quality, 0-51)
qp = 20
EOF
```

**Step 2: Verify template**

Run: `grep "{{CODEC}}" templates/sunshine.conf.template`
Expected: Found placeholder

**Step 3: Commit template**

```bash
git add templates/sunshine.conf.template
git commit -m "feat: add sunshine config template"
```

---

## Task 4: Create Systemd Override Template

**Files:**
- Create: `templates/sunshine-override.conf`

**Step 1: Create systemd override template**

```bash
cat > templates/sunshine-override.conf << 'EOF'
[Service]
Environment="DISPLAY=:0"
Environment="XAUTHORITY=/run/user/1000/gdm/Xauthority"
EOF
```

**Step 2: Verify template**

Run: `cat templates/sunshine-override.conf`
Expected: Service section with Environment variables

**Step 3: Commit template**

```bash
git add templates/sunshine-override.conf
git commit -m "feat: add systemd override template for sunshine"
```

---

## Task 5: Create Installation Script - Part 1 (Colors and Logo)

**Files:**
- Create: `install.sh`

**Step 1: Create script with colors and logo**

```bash
cat > install.sh << 'SCRIPT_EOF'
#!/bin/bash
set -e

# NVIDIA DGX Spark - Sunshine Headless Streaming Setup
# Automated installer for headless remote desktop via Sunshine/Moonlight

# ============================================================================
# ANSI Color Codes (NVIDIA Branding)
# ============================================================================
NVIDIA_GREEN='\033[38;5;112m'
BRIGHT_GREEN='\033[1;92m'
WHITE_BOLD='\033[1;37m'
GRAY='\033[0;90m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
RESET='\033[0m'

# ============================================================================
# Display Functions
# ============================================================================
show_logo() {
    echo -e "${NVIDIA_GREEN}"
    cat << 'LOGO'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                      â•‘
â•‘   â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•    â•‘
â•‘   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—   â•‘
â•‘   â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•‘
â•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â•‘
â•‘   â•šâ•â•  â•šâ•â•â•â•  â•šâ•â•â•â•  â•šâ•â•â•šâ•â•â•â•â•â• â•šâ•â•â•šâ•â•  â•šâ•â•    â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•    â•‘
â•‘                                                                      â•‘
â•‘                      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—       â•‘
â•‘                      â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•       â•‘
â•‘                      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•        â•‘
â•‘                      â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—        â•‘
â•‘                      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—       â•‘
â•‘                      â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•       â•‘
â•‘                                                                      â•‘
â•‘              Sunshine Headless Streaming Setup v1.0                 â•‘
â•‘                                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LOGO
    echo -e "${RESET}"
}

print_header() {
    echo -e "\n${NVIDIA_GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${NVIDIA_GREEN}â•‘${RESET} ${WHITE_BOLD}$1${RESET}"
    echo -e "${NVIDIA_GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}\n"
}

print_step() {
    echo -e "${BRIGHT_GREEN}[â†’]${RESET} $1"
}

print_success() {
    echo -e "${NVIDIA_GREEN}[âœ“]${RESET} $1"
}

print_error() {
    echo -e "${RED}[âœ—]${RESET} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${RESET} $1"
}

print_info() {
    echo -e "${GRAY}    $1${RESET}"
}

SCRIPT_EOF
```

**Step 2: Make script executable**

Run: `chmod +x install.sh`

**Step 3: Test logo display**

Run: `./install.sh` (will error but should show logo functions)
Expected: Script is executable

**Step 4: Commit script foundation**

```bash
git add install.sh
git commit -m "feat: add install script with NVIDIA branding and colors"
```

---

## Task 6: Create Installation Script - Part 2 (Prerequisites Check)

**Files:**
- Modify: `install.sh`

**Step 1: Add prerequisites check functions**

Append to `install.sh`:

```bash
# ============================================================================
# Prerequisites Check Functions
# ============================================================================
check_gb10_gpu() {
    print_step "Checking for NVIDIA GB10 GPU..."
    if ! nvidia-smi &>/dev/null; then
        print_error "NVIDIA GPU not detected!"
        print_info "This script requires NVIDIA DGX Spark with GB10 GPU"
        exit 1
    fi

    if nvidia-smi -L | grep -q "GB10"; then
        print_success "NVIDIA GB10 GPU detected"
        return 0
    else
        print_warning "GB10 GPU not detected, but NVIDIA GPU found"
        read -p "$(echo -e ${YELLOW}Continue anyway? [y/N]:${RESET} )" -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
}

check_running_as_user() {
    print_step "Checking user permissions..."
    if [[ $EUID -eq 0 ]]; then
        print_error "Do not run this script as root!"
        print_info "Run as normal user; sudo will be prompted when needed"
        exit 1
    fi
    print_success "Running as user: $USER"
}

check_autologin() {
    print_step "Checking auto-login configuration..."
    if sudo grep -q "AutomaticLoginEnable.*true" /etc/gdm3/custom.conf 2>/dev/null; then
        print_success "Auto-login is configured"
        return 0
    else
        print_warning "Auto-login not configured"
        print_info "Headless streaming requires auto-login to be enabled"
        print_info "Please configure auto-login in /etc/gdm3/custom.conf"
        print_info ""
        print_info "Add these lines under [daemon]:"
        print_info "  AutomaticLoginEnable = true"
        print_info "  AutomaticLogin = $USER"
        exit 1
    fi
}

run_prerequisites() {
    print_header "Prerequisites Check"
    check_running_as_user
    check_gb10_gpu
    check_autologin
    echo ""
}
```

**Step 2: Verify functions added**

Run: `grep "check_gb10_gpu" install.sh`
Expected: Function definition found

**Step 3: Commit prerequisites functions**

```bash
git add install.sh
git commit -m "feat: add prerequisites check functions"
```

---

## Task 7: Create Installation Script - Part 3 (Interactive Configuration)

**Files:**
- Modify: `install.sh`

**Step 1: Add interactive configuration functions**

Append to `install.sh`:

```bash
# ============================================================================
# Configuration Variables
# ============================================================================
RESOLUTION=""
FPS=""
CODEC=""
BITRATE=""
EDID_SOURCE=""
CUSTOM_EDID_PATH=""

# ============================================================================
# Interactive Configuration Functions
# ============================================================================
configure_resolution() {
    print_header "Display Configuration"
    echo -e "${BRIGHT_GREEN}â–º Select resolution and refresh rate:${RESET}\n"
    echo -e "  ${CYAN}1)${RESET} 3840x2160 @ 60Hz  ${GRAY}(4K, 60fps)${RESET}"
    echo -e "  ${CYAN}2)${RESET} 2560x1440 @ 120Hz ${GRAY}(1440p, 120fps)${RESET} ${NVIDIA_GREEN}[Recommended]${RESET}"
    echo -e "  ${CYAN}3)${RESET} 1920x1080 @ 120Hz ${GRAY}(1080p, 120fps)${RESET}"
    echo ""

    while true; do
        read -p "$(echo -e ${BRIGHT_GREEN}Your choice [1-3]:${RESET} )" choice
        case $choice in
            1)
                RESOLUTION="3840x2160"
                FPS="60"
                print_success "Selected: 4K @ 60Hz"
                break
                ;;
            2)
                RESOLUTION="2560x1440"
                FPS="120"
                print_success "Selected: 1440p @ 120Hz"
                break
                ;;
            3)
                RESOLUTION="1920x1080"
                FPS="120"
                print_success "Selected: 1080p @ 120Hz"
                break
                ;;
            *)
                print_error "Invalid choice. Please enter 1, 2, or 3"
                ;;
        esac
    done
    echo ""
}

configure_codec() {
    print_header "Video Codec Selection"
    echo -e "${BRIGHT_GREEN}â–º Select video codec:${RESET}\n"
    echo -e "  ${CYAN}1)${RESET} HEVC (H.265) ${NVIDIA_GREEN}[Recommended]${RESET} ${GRAY}- Universal compatibility${RESET}"
    echo -e "  ${CYAN}2)${RESET} AV1          ${GRAY}- Better compression, newer clients only${RESET}"
    echo -e "  ${CYAN}3)${RESET} H.264        ${GRAY}- Maximum compatibility, less efficient${RESET}"
    echo ""

    while true; do
        read -p "$(echo -e ${BRIGHT_GREEN}Your choice [1-3]:${RESET} )" choice
        case $choice in
            1)
                CODEC="hevc"
                print_success "Selected: HEVC (H.265)"
                break
                ;;
            2)
                CODEC="av1"
                print_success "Selected: AV1"
                break
                ;;
            3)
                CODEC="h264"
                print_success "Selected: H.264"
                break
                ;;
            *)
                print_error "Invalid choice. Please enter 1, 2, or 3"
                ;;
        esac
    done
    echo ""
}

configure_bitrate() {
    print_header "Bitrate Configuration"
    echo -e "${BRIGHT_GREEN}â–º Enter streaming bitrate in Mbps:${RESET}"
    echo -e "  ${GRAY}Recommended: 150 Mbps for LAN, 50 Mbps for remote${RESET}\n"

    while true; do
        read -p "$(echo -e ${BRIGHT_GREEN}Bitrate [150]:${RESET} )" input_bitrate
        input_bitrate=${input_bitrate:-150}

        if [[ "$input_bitrate" =~ ^[0-9]+$ ]] && [ "$input_bitrate" -gt 0 ]; then
            BITRATE=$((input_bitrate * 1000))  # Convert to Kbps
            print_success "Selected: ${input_bitrate} Mbps"
            break
        else
            print_error "Invalid bitrate. Please enter a positive number"
        fi
    done
    echo ""
}

configure_edid() {
    print_header "EDID Configuration"
    echo -e "${BRIGHT_GREEN}â–º Select EDID source:${RESET}\n"
    echo -e "  ${CYAN}1)${RESET} Bundled Samsung Q800T EDID ${NVIDIA_GREEN}[Recommended]${RESET}"
    echo -e "     ${GRAY}Tested and working on GB10 hardware${RESET}"
    echo -e "  ${CYAN}2)${RESET} Custom EDID file"
    echo -e "     ${GRAY}Provide path to your own .bin file${RESET}"
    echo ""

    while true; do
        read -p "$(echo -e ${BRIGHT_GREEN}Your choice [1-2]:${RESET} )" choice
        case $choice in
            1)
                EDID_SOURCE="bundled"
                print_success "Selected: Samsung Q800T EDID"
                break
                ;;
            2)
                EDID_SOURCE="custom"
                read -p "$(echo -e ${BRIGHT_GREEN}Enter path to EDID file:${RESET} )" CUSTOM_EDID_PATH
                if [[ -f "$CUSTOM_EDID_PATH" ]]; then
                    print_success "Custom EDID: $CUSTOM_EDID_PATH"
                    break
                else
                    print_error "File not found: $CUSTOM_EDID_PATH"
                fi
                ;;
            *)
                print_error "Invalid choice. Please enter 1 or 2"
                ;;
        esac
    done
    echo ""
}

show_configuration_summary() {
    print_header "Configuration Summary"
    echo -e "${WHITE_BOLD}Selected Configuration:${RESET}\n"
    echo -e "  ${CYAN}Resolution:${RESET}  $RESOLUTION @ ${FPS}Hz"
    echo -e "  ${CYAN}Codec:${RESET}       $CODEC"
    echo -e "  ${CYAN}Bitrate:${RESET}     $((BITRATE / 1000)) Mbps"
    echo -e "  ${CYAN}EDID:${RESET}        $EDID_SOURCE"
    if [[ "$EDID_SOURCE" == "custom" ]]; then
        echo -e "  ${CYAN}EDID File:${RESET}   $CUSTOM_EDID_PATH"
    fi
    echo ""

    read -p "$(echo -e ${YELLOW}Proceed with installation? [y/N]:${RESET} )" -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_error "Installation cancelled by user"
        exit 0
    fi
    echo ""
}
```

**Step 2: Verify configuration functions**

Run: `grep "configure_resolution" install.sh`
Expected: Function found

**Step 3: Commit configuration functions**

```bash
git add install.sh
git commit -m "feat: add interactive configuration prompts"
```

---

## Task 8: Create Installation Script - Part 4 (Backup Functions)

**Files:**
- Modify: `install.sh`

**Step 1: Add backup functions**

Append to `install.sh`:

```bash
# ============================================================================
# Backup Functions
# ============================================================================
BACKUP_DIR=""

create_backup() {
    print_header "Backing Up Existing Configuration"

    BACKUP_DIR="$HOME/.sunshine-setup-backup-$(date +%Y-%m-%d-%H%M%S)"
    mkdir -p "$BACKUP_DIR"
    print_success "Created backup directory: $BACKUP_DIR"

    # Backup xorg.conf
    if [[ -f /etc/X11/xorg.conf ]]; then
        print_step "Backing up /etc/X11/xorg.conf"
        sudo cp /etc/X11/xorg.conf "$BACKUP_DIR/xorg.conf"
        print_success "xorg.conf backed up"
    fi

    # Backup sunshine config
    if [[ -f "$HOME/.config/sunshine/sunshine.conf" ]]; then
        print_step "Backing up sunshine.conf"
        cp "$HOME/.config/sunshine/sunshine.conf" "$BACKUP_DIR/sunshine.conf"
        print_success "sunshine.conf backed up"
    fi

    # Backup EDID
    if [[ -f /etc/X11/4k120.edid ]]; then
        print_step "Backing up EDID file"
        sudo cp /etc/X11/4k120.edid "$BACKUP_DIR/4k120.edid"
        print_success "EDID backed up"
    fi

    # Backup systemd override
    if [[ -f "$HOME/.config/systemd/user/sunshine.service.d/override.conf" ]]; then
        print_step "Backing up systemd override"
        cp "$HOME/.config/systemd/user/sunshine.service.d/override.conf" "$BACKUP_DIR/sunshine-override.conf"
        print_success "Systemd override backed up"
    fi

    echo ""
    print_info "Backups saved to: $BACKUP_DIR"
    echo ""
}
```

**Step 2: Verify backup function**

Run: `grep "create_backup" install.sh`
Expected: Function found

**Step 3: Commit backup functions**

```bash
git add install.sh
git commit -m "feat: add backup functions for existing configs"
```

---

## Task 9: Create Installation Script - Part 5 (Sunshine Installation)

**Files:**
- Modify: `install.sh`

**Step 1: Add Sunshine installation function**

Append to `install.sh`:

```bash
# ============================================================================
# Sunshine Installation
# ============================================================================
install_sunshine() {
    print_header "Installing Sunshine"

    # Check if already installed
    if systemctl --user is-active sunshine &>/dev/null; then
        print_step "Stopping existing Sunshine service"
        systemctl --user stop sunshine
    fi

    # Get latest release URL for ARM64
    print_step "Fetching latest Sunshine release for ARM64..."
    LATEST_URL=$(curl -s https://api.github.com/repos/LizardByte/Sunshine/releases/latest | \
        grep "browser_download_url.*arm64.deb" | \
        cut -d '"' -f 4)

    if [[ -z "$LATEST_URL" ]]; then
        print_error "Failed to fetch latest Sunshine release"
        exit 1
    fi

    print_success "Found: $LATEST_URL"

    # Download
    print_step "Downloading Sunshine..."
    TEMP_DEB="/tmp/sunshine-latest-arm64.deb"
    curl -L "$LATEST_URL" -o "$TEMP_DEB"
    print_success "Downloaded to $TEMP_DEB"

    # Install
    print_step "Installing Sunshine package..."
    sudo dpkg -i "$TEMP_DEB" || sudo apt-get install -f -y
    print_success "Sunshine installed"

    # Cleanup
    rm -f "$TEMP_DEB"

    echo ""
}
```

**Step 2: Verify function**

Run: `grep "install_sunshine" install.sh`
Expected: Function found

**Step 3: Commit Sunshine installation**

```bash
git add install.sh
git commit -m "feat: add Sunshine installation from GitHub releases"
```

---

## Task 10: Create Installation Script - Part 6 (EDID Configuration)

**Files:**
- Modify: `install.sh`

**Step 1: Add EDID installation function**

Append to `install.sh`:

```bash
# ============================================================================
# EDID Configuration
# ============================================================================
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

install_edid() {
    print_header "Installing EDID File"

    if [[ "$EDID_SOURCE" == "bundled" ]]; then
        EDID_FILE="$SCRIPT_DIR/edid/samsung-q800t.bin"

        if [[ ! -f "$EDID_FILE" ]]; then
            print_error "Bundled EDID not found: $EDID_FILE"
            print_info "Downloading from linuxtv.org..."
            mkdir -p "$SCRIPT_DIR/edid"
            curl -L "https://git.linuxtv.org/v4l-utils.git/plain/utils/edid-decode/data/samsung-q800t-hdmi2.1" \
                -o "$EDID_FILE"
        fi

        print_step "Installing Samsung Q800T EDID"
    else
        EDID_FILE="$CUSTOM_EDID_PATH"
        print_step "Installing custom EDID: $EDID_FILE"
    fi

    # Verify EDID is valid
    if ! file "$EDID_FILE" | grep -q "EDID data"; then
        print_warning "File may not be valid EDID data"
        read -p "$(echo -e ${YELLOW}Continue anyway? [y/N]:${RESET} )" -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi

    # Install EDID
    sudo cp "$EDID_FILE" /etc/X11/4k120.edid
    sudo chmod 644 /etc/X11/4k120.edid
    print_success "EDID installed to /etc/X11/4k120.edid"

    echo ""
}
```

**Step 2: Verify function**

Run: `grep "install_edid" install.sh`
Expected: Function found

**Step 3: Commit EDID installation**

```bash
git add install.sh
git commit -m "feat: add EDID installation with validation"
```

---

## Task 11: Create Installation Script - Part 7 (X11 Configuration)

**Files:**
- Modify: `install.sh`

**Step 1: Add X11 configuration function**

Append to `install.sh`:

```bash
# ============================================================================
# X11 Configuration
# ============================================================================
configure_xorg() {
    print_header "Configuring X11 (xorg.conf)"

    # Get GPU BusID
    print_step "Detecting GPU BusID..."
    BUS_ID=$(lspci | grep -i "vga\|3d\|display" | head -1 | cut -d' ' -f1)

    if [[ -z "$BUS_ID" ]]; then
        print_error "Failed to detect GPU BusID"
        exit 1
    fi

    # Convert to X11 format (e.g., 000f:01:00.0 -> PCI:1@15:0:0)
    IFS=':.' read -r domain bus dev func <<< "$BUS_ID"
    domain_dec=$((16#$domain))
    bus_dec=$((16#$bus))
    XORG_BUS_ID="PCI:${dev}@${domain_dec}:${bus_dec}:${func}"

    print_success "GPU BusID: $XORG_BUS_ID"

    # Create xorg.conf from template
    print_step "Generating xorg.conf..."
    XORG_TEMPLATE="$SCRIPT_DIR/templates/xorg.conf.template"

    if [[ ! -f "$XORG_TEMPLATE" ]]; then
        print_error "Template not found: $XORG_TEMPLATE"
        print_info "Using nvidia-xconfig to generate configuration..."
        sudo nvidia-xconfig --custom-edid="DFP-0:/etc/X11/4k120.edid"
    else
        # Use template and replace BUS_ID
        sed "s/{{BUS_ID}}/$XORG_BUS_ID/g" "$XORG_TEMPLATE" | sudo tee /etc/X11/xorg.conf > /dev/null
    fi

    print_success "xorg.conf configured"

    echo ""
}
```

**Step 2: Verify function**

Run: `grep "configure_xorg" install.sh`
Expected: Function found

**Step 3: Commit X11 configuration**

```bash
git add install.sh
git commit -m "feat: add X11 configuration with BusID detection"
```

---

## Task 12: Create Installation Script - Part 8 (Sunshine Configuration)

**Files:**
- Modify: `install.sh`

**Step 1: Add Sunshine configuration function**

Append to `install.sh`:

```bash
# ============================================================================
# Sunshine Configuration
# ============================================================================
configure_sunshine() {
    print_header "Configuring Sunshine"

    # Create config directory
    mkdir -p "$HOME/.config/sunshine"

    # Generate sunshine.conf
    print_step "Creating sunshine.conf..."
    SUNSHINE_TEMPLATE="$SCRIPT_DIR/templates/sunshine.conf.template"

    if [[ -f "$SUNSHINE_TEMPLATE" ]]; then
        sed -e "s/{{BITRATE}}/$BITRATE/g" \
            -e "s/{{CODEC}}/$CODEC/g" \
            -e "s/{{FPS}}/$FPS/g" \
            "$SUNSHINE_TEMPLATE" > "$HOME/.config/sunshine/sunshine.conf"
    else
        # Generate from scratch
        cat > "$HOME/.config/sunshine/sunshine.conf" << EOF
# Sunshine Configuration
output_name = HDMI-0
bitrate = $BITRATE
encoder = nvenc
codec = $CODEC
fps = $FPS
qp = 20
EOF
    fi

    print_success "sunshine.conf created"

    # Create systemd override
    print_step "Creating systemd service override..."
    mkdir -p "$HOME/.config/systemd/user/sunshine.service.d"

    SYSTEMD_TEMPLATE="$SCRIPT_DIR/templates/sunshine-override.conf"
    if [[ -f "$SYSTEMD_TEMPLATE" ]]; then
        cp "$SYSTEMD_TEMPLATE" "$HOME/.config/systemd/user/sunshine.service.d/override.conf"
    else
        cat > "$HOME/.config/systemd/user/sunshine.service.d/override.conf" << EOF
[Service]
Environment="DISPLAY=:0"
Environment="XAUTHORITY=/run/user/1000/gdm/Xauthority"
EOF
    fi

    print_success "Systemd override created"

    # Reload systemd
    systemctl --user daemon-reload

    # Enable and start service
    print_step "Enabling Sunshine service..."
    systemctl --user enable sunshine

    echo ""
}
```

**Step 2: Verify function**

Run: `grep "configure_sunshine" install.sh`
Expected: Function found

**Step 3: Commit Sunshine configuration**

```bash
git add install.sh
git commit -m "feat: add Sunshine configuration with templates"
```

---

## Task 13: Create Installation Script - Part 9 (Validation & Main Flow)

**Files:**
- Modify: `install.sh`

**Step 1: Add validation and main flow**

Append to `install.sh`:

```bash
# ============================================================================
# Validation
# ============================================================================
validate_installation() {
    print_header "Validating Installation"

    # Wait for GDM restart
    print_step "Waiting for display manager to restart..."
    sleep 5

    # Check if X server is running
    print_step "Checking X server..."
    if pgrep -x Xorg > /dev/null; then
        print_success "X server is running"
    else
        print_warning "X server not detected (may need manual restart)"
    fi

    # Check display modes
    print_step "Checking virtual display..."
    export DISPLAY=:0
    export XAUTHORITY=/run/user/1000/gdm/Xauthority

    if xrandr 2>/dev/null | grep -q "HDMI-0 connected"; then
        print_success "Virtual display detected"

        # Show available modes
        echo ""
        print_info "Available display modes:"
        xrandr 2>/dev/null | grep "HDMI-0" -A 10 | grep -E "^\s+[0-9]+" | head -5 | while read line; do
            print_info "  $line"
        done
        echo ""
    else
        print_warning "Virtual display not detected"
        print_info "You may need to restart the system"
    fi

    # Check Sunshine service
    print_step "Checking Sunshine service..."
    if systemctl --user is-enabled sunshine &>/dev/null; then
        print_success "Sunshine is enabled (autostart on boot)"
    fi

    echo ""
}

show_next_steps() {
    print_header "Installation Complete!"

    echo -e "${NVIDIA_GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
    echo -e "${NVIDIA_GREEN}â•‘${RESET} ${WHITE_BOLD}Next Steps:${RESET}"
    echo -e "${NVIDIA_GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}\n"

    echo -e "${CYAN}1. Restart GDM or reboot system:${RESET}"
    echo -e "   ${GRAY}sudo systemctl restart gdm${RESET}"
    echo -e "   ${GRAY}# OR #${RESET}"
    echo -e "   ${GRAY}sudo reboot${RESET}\n"

    echo -e "${CYAN}2. Start Sunshine service:${RESET}"
    echo -e "   ${GRAY}systemctl --user start sunshine${RESET}\n"

    echo -e "${CYAN}3. Access Sunshine Web UI:${RESET}"
    echo -e "   ${GRAY}https://localhost:47990${RESET}"
    echo -e "   ${GRAY}https://<your-ip>:47990${RESET}\n"

    echo -e "${CYAN}4. Configure Moonlight client:${RESET}"
    echo -e "   ${GRAY}Resolution: $RESOLUTION${RESET}"
    echo -e "   ${GRAY}FPS:        $FPS${RESET}"
    echo -e "   ${GRAY}Bitrate:    $((BITRATE / 1000)) Mbps${RESET}"
    echo -e "   ${GRAY}Codec:      $CODEC${RESET}\n"

    if [[ -n "$BACKUP_DIR" ]]; then
        echo -e "${YELLOW}Backups saved to:${RESET}"
        echo -e "   ${GRAY}$BACKUP_DIR${RESET}\n"
    fi

    echo -e "${NVIDIA_GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}\n"
}

# ============================================================================
# Main Execution Flow
# ============================================================================
main() {
    show_logo
    run_prerequisites

    # Interactive configuration
    configure_resolution
    configure_codec
    configure_bitrate
    configure_edid
    show_configuration_summary

    # Installation
    create_backup
    install_sunshine
    install_edid
    configure_xorg
    configure_sunshine

    # Restart GDM
    print_header "Restarting Display Manager"
    print_step "Restarting GDM..."
    sudo systemctl restart gdm
    print_success "GDM restarted"
    echo ""

    # Validation
    validate_installation

    # Show next steps
    show_next_steps
}

# Run main function
main
SCRIPT_EOF
```

**Step 2: Make script executable (if not already)**

Run: `chmod +x install.sh`

**Step 3: Verify script is complete**

Run: `grep "main()" install.sh`
Expected: Main function found

Run: `bash -n install.sh`
Expected: No syntax errors

**Step 4: Commit final script**

```bash
git add install.sh
git commit -m "feat: add validation and main execution flow"
```

---

## Task 14: Create README Documentation

**Files:**
- Create: `README.md`

**Step 1: Create comprehensive README**

```bash
cat > README.md << 'EOF'
# DGX Spark Sunshine Headless Setup

Automated installer for **Sunshine** headless streaming on **NVIDIA DGX Spark (GB10)** systems.

Stream your desktop remotely via [Moonlight](https://moonlight-stream.org/) without any physical monitor attachedâ€”using virtual display configuration with NVIDIA CustomEDID.

![NVIDIA DGX Spark](https://img.shields.io/badge/NVIDIA-DGX%20Spark-76B900?style=flat&logo=nvidia)
![Platform](https://img.shields.io/badge/platform-ARM64-blue)
![License](https://img.shields.io/badge/license-MIT-green)

---

## Features

- âœ… **Fully automated** - Single script installation
- âœ… **Interactive configuration** - Choose resolution, codec, bitrate
- âœ… **NVIDIA-optimized** - Hardware NVENC encoding (H.264/HEVC/AV1)
- âœ… **Virtual display** - No physical dummy plug required
- âœ… **Smart backups** - Automatic config backups with timestamps
- âœ… **Validated setup** - Post-install verification

## Supported Configurations

| Resolution       | Refresh Rate | Notes                          |
|------------------|--------------|--------------------------------|
| 3840x2160 (4K)   | 60Hz         | Maximum detail, smooth 60fps   |
| 2560x1440 (1440p)| 120Hz        | **Recommended** - Best balance |
| 1920x1080 (1080p)| 120Hz        | Maximum FPS, lower bandwidth   |

**Codecs:** HEVC (H.265), AV1, H.264

---

## Prerequisites

Before running the installer, ensure:

1. **NVIDIA DGX Spark** with GB10 GPU
2. **Desktop environment** installed (GNOME/Ubuntu Desktop)
3. **Auto-login configured** in `/etc/gdm3/custom.conf`:
   ```ini
   [daemon]
   AutomaticLoginEnable = true
   AutomaticLogin = <your-username>
   ```
4. **Internet connection** (to download Sunshine)

---

## Quick Start

### Option 1: Clone and Run (Recommended)

```bash
# Clone repository
git clone <your-repo-url> ~/repos/dgx-spark-sunshine-setup
cd ~/repos/dgx-spark-sunshine-setup

# Run installer
./install.sh
```

### Option 2: Direct Download

```bash
curl -fsSL <raw-url>/install.sh | bash
```

---

## Installation Steps

The installer will guide you through:

1. **Prerequisites check** - Verify GB10 GPU, auto-login, permissions
2. **Display configuration** - Choose resolution and refresh rate
3. **Codec selection** - Select HEVC, AV1, or H.264
4. **Bitrate configuration** - Set streaming quality
5. **EDID selection** - Use bundled or custom EDID
6. **Backup** - Automatic backup of existing configs
7. **Installation** - Download and install Sunshine
8. **Configuration** - Set up virtual display and Sunshine
9. **Validation** - Verify installation succeeded

---

## Post-Installation

After installation completes:

### 1. Restart System (Recommended)

```bash
sudo reboot
```

**OR** restart GDM:

```bash
sudo systemctl restart gdm
```

### 2. Start Sunshine

```bash
systemctl --user start sunshine
```

### 3. Access Web UI

Open in browser:
- **Local:** https://localhost:47990
- **LAN:** https://<your-ip>:47990
- **Tailscale:** https://<tailscale-name>:47990

Create credentials when prompted.

### 4. Configure Moonlight Client

Download [Moonlight](https://moonlight-stream.org/) for your platform.

**Settings to match your installation:**
- Resolution: Match what you selected (e.g., 2560x1440)
- FPS: Match your selection (e.g., 120)
- Bitrate: Match your selection (e.g., 150 Mbps)
- Codec: H.265 (HEVC) or Auto

**Pair with DGX:**
1. Launch Moonlight
2. Detect "spark" (or your hostname)
3. Click to pair
4. Enter PIN shown in Moonlight into Sunshine Web UI

---

## Troubleshooting

### Display Not Detected

```bash
# Check X server logs
journalctl -b | grep -i "nvidia.*edid"

# Verify EDID installed
ls -la /etc/X11/4k120.edid

# Restart GDM
sudo systemctl restart gdm
```

### Sunshine Not Running

```bash
# Check service status
systemctl --user status sunshine

# View logs
journalctl --user -u sunshine -f

# Restart service
systemctl --user restart sunshine
```

### Wrong Display Modes

The bundled Samsung Q800T EDID is tested and working. If using custom EDID and experiencing issues, the GB10's 165 MHz pixel clock limitation may prevent certain high-bandwidth modes.

**Solution:** Use bundled EDID or run installer again and select option 1.

---

## Technical Details

### Virtual Display Method

Uses **NVIDIA CustomEDID** via `xorg.conf`:
- EDID file: `/etc/X11/4k120.edid`
- X11 config: `/etc/X11/xorg.conf`
- Forces virtual display on DFP-0 connector
- No physical hardware required

### File Locations

- **Sunshine config:** `~/.config/sunshine/sunshine.conf`
- **Systemd override:** `~/.config/systemd/user/sunshine.service.d/override.conf`
- **Backups:** `~/.sunshine-setup-backup-<timestamp>/`

### Hardware Constraints

**GB10 TMDS Limitation:** 165 MHz pixel clock maximum
- âœ… 4K @ 60Hz supported
- âœ… 1440p @ 120Hz supported
- âŒ 4K @ 120Hz **NOT** supported (requires ~1200 MHz)

---

## Uninstallation

```bash
# Stop and disable Sunshine
systemctl --user stop sunshine
systemctl --user disable sunshine

# Remove Sunshine
sudo apt remove sunshine

# Restore backups (if needed)
BACKUP_DIR=~/.sunshine-setup-backup-<timestamp>
sudo cp $BACKUP_DIR/xorg.conf /etc/X11/xorg.conf
cp $BACKUP_DIR/sunshine.conf ~/.config/sunshine/sunshine.conf

# Restart GDM
sudo systemctl restart gdm
```

---

## Contributing

Contributions welcome! Please open issues or pull requests.

---

## License

MIT License - See LICENSE file for details

---

## Resources

- [Sunshine Documentation](https://docs.lizardbyte.dev/projects/sunshine/)
- [Moonlight Clients](https://moonlight-stream.org/)
- [NVIDIA DGX Spark](https://www.nvidia.com/en-us/data-center/dgx-spark/)
- [EDID Resources](https://git.linuxtv.org/v4l-utils.git/tree/utils/edid-decode/data)

---

**Made with ğŸ’š for NVIDIA DGX Spark**
EOF
```

**Step 2: Verify README**

Run: `cat README.md | head -20`
Expected: README header visible

**Step 3: Commit README**

```bash
git add README.md
git commit -m "docs: add comprehensive README"
```

---

## Task 15: Final Repository Setup

**Files:**
- Create: `.gitignore`
- Create: `LICENSE`

**Step 1: Create .gitignore**

```bash
cat > .gitignore << 'EOF'
# Backup files
*.backup
*.bak
*~

# Temp files
*.tmp
*.swp
.DS_Store

# Test files
test_*
EOF
```

**Step 2: Create MIT License**

```bash
cat > LICENSE << 'EOF'
MIT License

Copyright (c) 2025 DGX Spark Sunshine Setup

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
EOF
```

**Step 3: Commit repository files**

```bash
git add .gitignore LICENSE
git commit -m "chore: add gitignore and MIT license"
```

**Step 4: Initialize git repository (if not already)**

```bash
cd /home/adminuser/repos/dgx-spark-sunshine-setup
git init
git add .
git commit -m "Initial commit: DGX Spark Sunshine automated installer"
```

**Step 5: Verify all files present**

Run: `ls -la`
Expected: All files present (install.sh, README.md, LICENSE, edid/, templates/, docs/)

Run: `git log --oneline`
Expected: All commits present

---

## Completion Checklist

- [x] Samsung Q800T EDID downloaded
- [x] X11 configuration template created
- [x] Sunshine configuration template created
- [x] Systemd override template created
- [x] Installation script with NVIDIA branding
- [x] Prerequisites validation
- [x] Interactive configuration prompts
- [x] Backup functionality
- [x] Sunshine installation from GitHub
- [x] EDID installation with validation
- [x] X11 auto-configuration
- [x] Sunshine service configuration
- [x] Post-install validation
- [x] Comprehensive README
- [x] Repository setup (git, license, gitignore)

---

## Testing the Installation

**Minimal test (syntax check):**
```bash
cd /home/adminuser/repos/dgx-spark-sunshine-setup
bash -n install.sh
```

**Full test (requires sudo, will modify system):**
```bash
./install.sh
# Follow interactive prompts
```

---

## Future Enhancements (Optional)

- Uninstall script (`uninstall.sh`)
- Resolution switching utility
- Automated testing framework
- Support for multiple EDID profiles
- GUI installer option
- Docker containerized version
